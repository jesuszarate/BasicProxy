from socket import *
import sys
import re
import urlparse

CRLF = "\r\n\r\n"

e_501 = "HTTP/1.0 501 Not Implemented\r\n"
e_400 = "HTTP/1.0 400 Bad Request\r\n"
e_200 = "HTTP/1.0 200 OK\r\n"

if len(sys.argv) <= 1:
    print('Usage : "python proxy.py PORT"\n[PORT : The port you want to connect to]')
    sys.exit(2)

serverPort = sys.argv[1]

if not str.isdigit(serverPort):
    print('Error: Port number must be a number')
    sys.exit(2)

serverPort = int(serverPort)

print ('Listening on port: ' + str(serverPort))

# TODO: make this an init
#  Socket initialization to start communication with the client
serverSocket = socket(AF_INET, SOCK_STREAM)
serverSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
serverSocket.bind(('', serverPort))
serverSocket.listen(100)

print ('The server is ready to receive...')


def check_format(list):
    if not re.match('([GET]|[get])', list[0]):
        print e_501
        return False, e_501

    if not re.match('\w+', list[1]):
        print e_400
        return False, e_400

    return True, e_200


def close_socket(socket_connection):
    print ('Closing socket...')
    socket_connection.close()
    print ('Socket closed!')


def gather_headers(connection_socket):
    headers = []
    while 1:
        message = connection_socket.recv(1024).decode()

        host = ''
        if not re.match("\w+:?\w+", message):
            if re.match("Host:\w+", message):
                host = message
            if message == "\r\n":
                return host, headers

        headers.append(message)


def generate_header_string(headers):
    header_str = ''
    host = ''
    for h in headers:
        header_str += h + CRLF
    return header_str


def GET(connection_socket, url, http_version):
    url = urlparse.urlparse(url)

    port = 80
    host = '/'
    path = '/'
    if url.port is not None:
        port = url.port
        print ('Port: ' + str(port))

    host, headers = gather_headers(connection_socket)
    if url.netloc is not None:
        host = url.netloc
        print 'Host: ' + host

    if url.path is not None:
        path = url.path

    print url.netloc

    forward_socket = socket(AF_INET, SOCK_STREAM)
    forward_socket.settimeout(0.30)

    forward_socket.connect((host, port))

    # Include the path here instead of just /
    http_version = "GET %s %s %s \nConnection: close %s" % (path, http_version, CRLF, CRLF) # Include the pat

    print ("http version " + http_version)

    forward_socket.send(http_version)
    data = (forward_socket.recv(1000000))
    close_socket(forward_socket)
    return data


while 1:
    connectionSocket, addr = serverSocket.accept()
    message = connectionSocket.recv(1024).decode()
    print('Message received.\n')

    # Check proper format
    requestParams = message.split()

    # Make sure it's in the following format <METHOD> <URL> <HTTP VERSION>
    status = check_format(requestParams)
    if status[0]:

        if len(requestParams) == 3:

            data = GET(connectionSocket, requestParams[1], requestParams[2])
            connectionSocket.send(data)

    else:
        connectionSocket.send(status[1].encode())

    close_socket(connectionSocket)
